## Гайд по агентам для проектов PortfelOnline

Этот документ нужен, чтобы **Cursor / Claude / другие код‑агенты** работали одинаково и предсказуемо во **всех 5 репозиториях**:

- `kadmap` — кадастровый сервис (`kadastrmap.info`)
- `n8n_1` — AI Consultant n8n стек
- `strategy-dashboard` — AI Consultant India Strategy Dashboard
- `github-connect-hub` — React‑дашборд для GitHub
- `personal` — личные заметки

Гайд описывает:

- как использовать **commands** (скрипты и команды проекта),
- как работать со **skills**,
- когда и зачем нужны **MCP**,
- как устроены **rules** (`.cursor/rules/`),
- что такое **системный `CLAUDE.md`** и **глобальные `settings.json`**,
- когда использовать **субагентов**,
- чем отличаются **plugins** от **MCP**.

---

## 1. Как агенты видят проекты

Во всех проектах мы придерживаемся одной схемы:

- **Короткий `CLAUDE.md` в корне репо** — только WHY / WHAT / HOW + ссылки на доки.
- **Узкие правила в `.cursor/rules/*.mdc`** — включаются только для нужных папок.
- **Толстые инструкции в `docs/` и `docs/agent/`** — настоящая “истина”.
- **Skill’ы** (например, `kadmap-superpowers`) — высокоуровневый “мозг” для проекта.

Для Cursor это значит:

- Открываешь репозиторий — он видит корневой `CLAUDE.md` + соответствующие `.cursor/rules`.
- Как только открываешь файл из `website/application/` или `server/`/`client/` и т.п. — подхватываются **правильные rules**.

---

## 2. Commands — как правильно “давать команды”

**Commands** — это:

- обычные команды, которые ты сам запускаешь (`php test_integration.php`, `npm run test`, `./scripts/deploy_to_kad20.sh`),
- те же команды, которые ты **просишь запустить агента**.

Принципы:

- **Один стабильный entrypoint на задачу.**
  - Запуск локально
  - Тесты
  - Деплой
- **Не зашивать сложные пайплайны в `CLAUDE.md` или rules.**
  - Хочешь сложный сценарий — запакуй в **скрипт** в репо.
  - В правила/доки давай только “одну кнопку”:  
    `./scripts/deploy_to_kad20.sh` или `npm run test`.

### Примеры по проектам

- `kadmap`
  - Дев/тесты: `php test_*.php` (по нужной задаче)
  - Деплой: `./scripts/deploy_to_kad20.sh` (см. `DEPLOY_COMMANDS.md`)
- `n8n_1`
  - Деплой стека: `ssh n` → `docker compose up -d`
  - Фиксы / скрипты деплоя — по докам `DEPLOYMENT.md`, `DEPLOY_FINAL.sh`
- `strategy-dashboard`
  - Дев: `npm run dev`
  - Тесты: `npm run test`
  - Typecheck: `npm run check`
- `github-connect-hub`
  - Дев: `npm run dev`
  - Линт/тесты: `npm run lint`, `npm run test`
- `personal`
  - Команд почти нет; по сути работа с markdown‑файлами.

---

## 3. Skills — когда нужны “суперспособности”

**Skill** — это отдельный файл с инструкциями для агента (например, `.cursor/skills/kadmap-superpowers/SKILL.md`), который:

- описывает **как думать и действовать в рамках проекта**,
- даёт общие принципы: как деплоить, какие доки читать, как проверять результат.

Принципы использования:

- Один skill отвечает за **один большой проект** (например, `kadmap`).
- Skill **не дублирует** `CLAUDE.md` или rules, а:
  - учит агента **искать нужные доки**,
  - напоминает про **обязательные проверки и команды**,
  - задаёт общий стиль работы (план → реализация → проверки).

Если нужно расширить поведение агента, сначала смотри:

- не подходит ли для этого **rules** (`.cursor/rules/*.mdc`) или **доки**,
- и только если нужно “сквозное” поведение по всему проекту — добавляй/правь skill.

---

## 4. MCP — когда нужны свои инструменты

**MCP (Model Context Protocol)** — это способ дать агенту **собственные инструменты**:

- MCP‑сервер описывает: какие есть методы (`getParcelData`, `getFiasAddress`, `runKadmapHealthCheck` и т.п.), какие параметры они принимают и что возвращают.
- Агент видит их как **tools**, которые можно вызывать внутри сессии.

Когда MCP особенно полезен:

- нужно, чтобы и Cursor, и Claude (и другие клиенты) могли:
  - ходить в твой backend (NSPD, FIAS, внутренние API),
  - вызывать сложные операции одной командой,
  - не держать “как сходить в API” в голове и в промпте.

Пример сценария:

- Вместо: “сделай запрос на такой‑то URL, обработай JSON, вытащи поле…”
- Ты даёшь MCP‑tool `kadmap_api.getParcelInfo(parcel_id)` — и уже он:
  - ходит в NSPD/FIAS,
  - логирует,
  - кеширует,
  - отдаёт чистый результат агенту.

Для всех 5 проектов MCP — это **общий слой над кодом**:

- `kadmap` / `n8n_1` / `strategy-dashboard` могут вызывать одни и те же MCP‑tools.
- Документация по MCP‑сервисам должна жить в **отдельных доках** (например, `docs/mcp/*.md`) и упоминаться в AGENT_GUIDE или rules.

---

## 5. Rules (`.cursor/rules/…`) — локальные “рельсы”

Вместо `.claude/rules/` мы используем **`.cursor/rules/*.mdc`** во всех репозиториях.

Формат:

```markdown
---
description: Кратко, что делает правило
globs: path/pattern/**
alwaysApply: false
---

# Название зоны

- Короткие, универсальные принципы для этой зоны.
- Ссылки на доки и команды, а не длинные инструкции.
```

Принципы:

- **alwaysApply: true** — только для базовых guardrails проекта (например, `kadmap-core`, `n8n-core`).
- Остальные правила — только через `globs`, чтобы:
  - при работе с `website/application/**` не мешали правила для `configs/**`,
  - правила активировались только когда действительно нужны.
- Внутри не копируем большие туториалы — только:
  - **что важно помнить** (версии PHP/Node, ограничения),
  - **какие доки читать**,
  - **какие команды запускать**.

---

## 6. Системный `CLAUDE.md` и глобальный `settings.json`

### Системный `CLAUDE.md` (`~/.claude/CLAUDE.md`)

Это **надпроектный** файл, который применяется:

- ко всем репозиториям,
- во всех сессиях.

В нём должны быть только:

- методология (как строить план, когда запускать тесты, как оформлять ответы),
- общие правила безопасности (не печатать секреты, не пушить `.env` и т.п.),
- формат ответов (язык, markdown, стиль).

Там **не должно быть**:

- конкретных путей (`website/application/`, `server/routers/` и т.п.),
- ничего про `kadmap`, `n8n_1`, `strategy-dashboard` и пр. — это уже домен project‑level `CLAUDE.md` и `.cursor/rules/`.

### Глобальный `settings.json` (`~/.claude/settings.json` / настройки Cursor)

Глобальные настройки управляют:

- **правами** агента (shell, git, сеть),
- включением/отключением **plugins**,
- политикой подтверждений (когда “делать сразу”, а когда “спросить сначала”).

Рекомендации:

- “опасные” действия (`git push`, `rm -rf`, изменения `git config`) — только с явным подтверждением.
- `network` для обычных операций (`git clone`, `npm install`) — можно разрешить.
- В проектах мы добавляем только **минимальный per‑repo `settings.json` для Cursor** (например, включаем `superpowers`), остальное — глобально.

---

## 7. Субагенты — когда их действительно стоит звать

Субагенты — это отдельные “персонажи”, заточенные под определённые задачи:

- `explore` — быстро ходит по коду, ищет файлы/паттерны.
- `code-reviewer` — делает ревью изменений по ветке/PR.
- `browser-use` — ходит в браузер, проверяет UI / E2E.
- `shell` / `generalPurpose` — может автономно выполнять цепочки команд.

Когда это полезно:

- **Большие изменения в `kadmap`**:
  - один агент пишет код,
  - второй (`explore`) собирает контекст по NSPD/FIAS/инфраструктуре.
- **Регулярные фичи в `strategy-dashboard` / `github-connect-hub`**:
  - после завершения ветки — `code-reviewer` сверяет всё с гайдом и rules.
- **Инфраструктурные задачи в `n8n_1`**:
  - subagent‑shell может прогнать серию диагностических скриптов по докам, пока ты анализируешь результаты.

Главная идея: **делить сложную задачу на независимые подпотоки**, когда это реально экономит время и не запутывает.

---

## 8. Plugins vs MCP

**Plugins**:

- готовые интеграции, которые поставляются вместе с IDE/клиентом (например, Cursor `superpowers`),
- обычно ты **не пишешь их сам**, а просто включаешь/настраиваешь.

**MCP**:

- открытый протокол для описания **своих** инструментов,
- один MCP‑сервер можно использовать из разных клиентов (Cursor, Claude, другие IDE).

Практическая разница:

- Для стандартных задач IDE (улучшенный shell, git, навигация по коду) — достаточно **plugins**.
- Для доменной логики (NSPD/FIAS, деплой на твои сервера, специфичный аудит) — лучше делать **MCP‑tools**, чтобы:
  - логика жила **в твоём коде**,
  - у тебя был полный контроль над безопасностью и логированием,
  - агенты могли переиспользовать один и тот же набор операций.

---

## 9. Как расширять этот гайд

1. **Добавлять новые разделы здесь**, а не в `CLAUDE.md` (чтобы он оставался тонким).
2. При необходимости:
   - добавлять **новые rules** в `.cursor/rules/*.mdc` под конкретные пути,
   - обновлять **skills**, если нужно поменять “общий стиль” работы агента.
3. Держать гайд и codebase в синхроне:
   - если меняются команды деплоя/тестов — обновлять и этот документ,
   - если появляется новый проект — добавлять его в список в начале.

Этот файл можно (и нужно) копировать/обновлять в других репозиториях (`docs/agent/AGENT_GUIDE.md`), чтобы в любом проекте Cursor и Claude работали по одним и тем же принципам.

